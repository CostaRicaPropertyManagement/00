<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Income / Outcome Dashboard (Light)</title>
  <!-- libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{ --brand:#2563eb; --bg:#ffffff; --card:#f8fafc; --text:#0f172a; --muted:#475569; --border:#e2e8f0; }
    body{background:var(--bg);color:var(--text)}
    .card{background:var(--card);border:1px solid var(--border)}
    .btn{border:1px solid var(--border);padding:.5rem .75rem;border-radius:.75rem;background:#fff}
    .btn:hover{background:#f1f5f9}
    .chip{border:1px solid var(--border);padding:.15rem .5rem;border-radius:999px;font-size:.75rem}
    .toast{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;padding:.5rem .75rem;border-radius:.75rem}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:6px;text-align:left}
    thead{background:#eef2f7}
    label.inline{display:inline-flex;align-items:center;gap:.5rem;font-size:.85rem;color:#334155}
  </style>
</head>
<body class="min-h-screen">
  <main class="max-w-6xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <h1 class="text-2xl font-bold">ðŸ’° Income / Outcome Dashboard</h1>
      <div class="flex flex-wrap gap-2 items-center">
        <input id="csvUrl" type="url" placeholder="Paste Google Sheet link (/edit, /export?format=csv, /pub?output=csv, or /d/e/.../pubhtml)" class="border rounded px-3 py-2 w-80"/>
        <button id="addLinkBtn" class="btn">Add link</button>
        <button id="loadBtn" class="btn">Load</button>
        <button id="refreshBtn" class="btn">Refresh (force fresh)</button>
        <label class="inline"><input id="alwaysFresh" type="checkbox"/> Always fetch fresh</label>
        <button id="clearCsvCacheBtn" class="btn">Purge CSV cache</button>
        <button id="loadSampleBtn" class="btn">Sample</button>
        <button id="resetBtn" class="btn">Reset</button>
      </div>
      <div id="statusBar" class="text-xs text-slate-600 mt-1"></div>
    </header>

    <!-- Saved Links -->
    <section id="linkList" class="hidden card p-3 rounded-xl">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Saved links</h2>
        <small class="text-slate-600">Tip: add multiple, commaâ€‘separated â€¢ use <code>?csv=URL1,URL2</code></small>
      </div>
      <ul id="linksUl" class="grid md:grid-cols-2 gap-2"></ul>
    </section>

    <!-- Preferences -->
    <section class="card p-3 rounded-xl">
      <h2 class="font-semibold mb-2">Preferences</h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
        <div>
          <label class="text-sm">Currency</label>
          <select id="currency" class="w-full border rounded px-2 py-1">
            <option>USD</option>
            <option>CRC</option>
            <option>EUR</option>
            <option>MXN</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Locale</label>
          <select id="locale" class="w-full border rounded px-2 py-1">
            <option>en-US</option>
            <option>es-CR</option>
            <option>es-ES</option>
            <option>en-GB</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Starting Balance</label>
          <input id="startingBalance" type="number" step="0.01" value="0" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
          <label class="text-sm">Low Balance Threshold</label>
          <input id="lowThreshold" type="number" step="0.01" value="100" class="w-full border rounded px-2 py-1"/>
        </div>
    
        <div class="flex items-end"><button id="saveSettingsBtn" class="btn w-full">Save</button></div>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid md:grid-cols-4 gap-3">
      <div class="card rounded-xl p-3"><div class="text-slate-500 text-sm">Total Income</div><div id="kpiIncome" class="text-2xl font-semibold">â€”</div></div>
      <div class="card rounded-xl p-3"><div class="text-slate-500 text-sm">Total Expenses</div><div id="kpiExpense" class="text-2xl font-semibold">â€”</div></div>
      <div class="card rounded-xl p-3"><div class="text-slate-500 text-sm">Net</div><div id="kpiNet" class="text-2xl font-semibold">â€”</div></div>
      <div class="card rounded-xl p-3"><div class="flex items-center justify-between"><div class="text-slate-500 text-sm">Current Balance</div><span id="balanceBadge" class="chip">â€”</span></div><div id="kpiBalance" class="text-2xl font-semibold">â€”</div></div>
    </section>

    <!-- Watchlist & Recommendations -->
    <section class="card p-3 rounded-xl">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Low Balance Watchlist & Recommendations</h2>
        <small class="text-slate-600">Includes 30â€‘day coverage check</small>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div class="overflow-x-auto">
          <table class="text-sm">
            <thead>
              <tr><th class="px-2 py-1">Date</th><th class="px-2 py-1 text-right">Running Balance</th><th class="px-2 py-1">Note</th></tr>
            </thead>
            <tbody id="alertsBody"></tbody>
          </table>
        </div>
        <div>
          <h3 class="font-semibold mb-1">Suggestions</h3>
          <ul id="recsList" class="list-disc list-inside text-sm space-y-1"></ul>
        </div>
      </div>
    </section>

    <!-- Charts -->
    <section class="grid md:grid-cols-2 gap-3">
      <div class="card rounded-xl p-3">
        <h3 class="font-semibold mb-2">Monthly Income vs Expense</h3>
        <canvas id="barChart" height="120" aria-label="Monthly income and expense chart" role="img"></canvas>
      </div>
      <div class="card rounded-xl p-3">
        <h3 class="font-semibold mb-2">Expense Breakdown</h3>
        <canvas id="pieChart" height="120" aria-label="Expense breakdown chart" role="img"></canvas>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-3 rounded-xl">
      <div class="flex items-center justify-between mb-2"><h2 class="font-semibold">Transactions (first 200)</h2><div class="text-xs text-slate-600">Click headers to sort</div></div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr>
              <th data-sort="date" class="px-3 py-2 text-left cursor-pointer">Date</th>
              <th data-sort="desc" class="px-3 py-2 text-left cursor-pointer">Description</th>
              <th data-sort="category" class="px-3 py-2 text-left cursor-pointer">Category</th>
              <th data-sort="type" class="px-3 py-2 text-left cursor-pointer">Type</th>
              <th data-sort="amount" class="px-3 py-2 text-right cursor-pointer">Amount</th>
              <th class="px-3 py-2 text-right">New Balance $</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between p-2 text-xs text-slate-600">
        <div>Showing <span id="rowCount">0</span> rows</div>
        <div class="flex gap-2 items-center">
          <button id="prevPage" class="btn">Prev</button>
          <span id="pageInfo"></span>
          <button id="nextPage" class="btn">Next</button>
        </div>
      </div>
    </section>

  </main>

  <script>
    // ===== State =====
    const LS_KEYS={ links:'io_links', settings:'io_settings', cache:'io_cache_v1' };
    let RAW_HEADERS = new Set();
    let RAW_ROWS = [];
    let SETTINGS = { currency:'USD', locale: navigator.language||'en-US', starting:0, low:100 };
    let SORT = { key:'date', dir:'desc' };
    let PAGE = { index:1, size:50 };

    // running balance per row id (computed once in chronological order)
    const RB = new Map(); // id -> running balance

    // ===== Els =====
    const csvUrl=document.getElementById('csvUrl');
    const addLinkBtn=document.getElementById('addLinkBtn');
    const loadBtn=document.getElementById('loadBtn');
    const refreshBtn=document.getElementById('refreshBtn');
    const alwaysFresh=document.getElementById('alwaysFresh');
    const loadSampleBtn=document.getElementById('loadSampleBtn');
    const resetBtn=document.getElementById('resetBtn');
    const linksUl=document.getElementById('linksUl');
    const linkList=document.getElementById('linkList');
    const statusBar=document.getElementById('statusBar');

    const currencySel=document.getElementById('currency');
    const localeSel=document.getElementById('locale');
    const startingBalanceEl=document.getElementById('startingBalance');
    const lowThresholdEl=document.getElementById('lowThreshold');
    const saveSettingsBtn=document.getElementById('saveSettingsBtn');

    const kpiIncome=document.getElementById('kpiIncome');
    const kpiExpense=document.getElementById('kpiExpense');
    const kpiNet=document.getElementById('kpiNet');
    const kpiBalance=document.getElementById('kpiBalance');
    const balanceBadge=document.getElementById('balanceBadge');

    const alertsBody=document.getElementById('alertsBody');
    const recsList=document.getElementById('recsList');

    const tbody=document.getElementById('tbody');
    const rowCount=document.getElementById('rowCount');
    const pageInfo=document.getElementById('pageInfo');
    const prevPage=document.getElementById('prevPage');
    const nextPage=document.getElementById('nextPage');

    // ===== Utils =====
    function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800); }
    const normalizeHeader = s => String(s||'').trim().toLowerCase().replace(/\s+/g,' ');
    const monthKey=d=> d.getFullYear()+ '-' + String(d.getMonth()+1).padStart(2,'0');
    function fmtCurrency(n){ try{ return new Intl.NumberFormat(SETTINGS.locale,{style:'currency',currency:SETTINGS.currency}).format(n);}catch{ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);} }

    function parseAmount(val){
      if(val==null) return NaN; let s=String(val).trim(); if(!s) return NaN; const neg=/^\(.*\)$/.test(s); s=s.replace(/[()]/g,''); s=s.replace(/[^0-9.,-]/g,'');
      if(s.includes(',') && s.includes('.')){ if(s.lastIndexOf('.')>s.lastIndexOf(',')) s=s.replace(/,/g,''); else s=s.replace(/\./g,'').replace(',', '.'); }
      else if(s.includes(',')){ const parts=s.split(','); if(parts[parts.length-1].length<=2) s=s.replace(/,/g,(m,i)=> i===s.lastIndexOf(',')?'.':''); else s=s.replace(/,/g,''); }
      else if(s.includes('.')){ const parts=s.split('.'); if(parts.length>2 && parts[parts.length-1].length===3) s=s.replace(/\./g,''); }
      const n=parseFloat(s); if(isNaN(n)) return NaN; return neg? -n : n;
    }

    function parseDate(val){
      if(!val) return null;
      // Native first
      const dNative = new Date(val);
      if(!isNaN(dNative)) return dNative;
      const s = String(val).trim();
      // 1) dd/mm/yyyy or mm/dd/yyyy or dd-mm-yy etc.
      let m = s.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})$/);
      if(m){ const [,a,b,y]=m; const yr=y.length===2?2000+parseInt(y):parseInt(y); const mm=parseInt(b), dd=parseInt(a); const d=new Date(yr,mm-1,dd); if(!isNaN(d)) return d; }
      // 2) mm/yyyy or yyyy-mm
      m = s.match(/^(\d{1,2})[\/.-](\d{4})$/);
      if(m){ const [,mm,yr]=m; const d=new Date(parseInt(yr),parseInt(mm)-1,1); if(!isNaN(d)) return d; }
      m = s.match(/^(\d{4})-(\d{1,2})$/);
      if(m){ const [,yr,mm]=m; const d=new Date(parseInt(yr),parseInt(mm)-1,1); if(!isNaN(d)) return d; }
      // 3) MMM yyyy, e.g., Aug 2025 / August 2025
      m = s.match(/^([A-Za-z]{3,})\s+(\d{4})$/);
      if(m){ const [,mon,yr]=m; const d=new Date(`${mon} 1, ${yr}`); if(!isNaN(d)) return d; }
      // 4) d-MMM-yy, 01-Aug-25
      m = s.match(/^(\d{1,2})[-\s]([A-Za-z]{3,})[-\s](\d{2,4})$/);
      if(m){ const [,dd,mon,yy]=m; const yr=String(yy).length===2?2000+parseInt(yy):parseInt(yy); const d=new Date(`${mon} ${dd}, ${yr}`); if(!isNaN(d)) return d; }
      return null;
    }

    function inferType(typeVal, amountVal){ if(typeVal!=null && String(typeVal).trim()!==''){ const v=normalizeHeader(typeVal); if(/income|ingreso|credit|cr|in\b/.test(v)) return 'income'; if(/expense|outcome|egreso|debit|dr|out\b/.test(v)) return 'expense'; } if(typeof amountVal==='number'&&!isNaN(amountVal)) return amountVal<0?'expense':'income'; return 'expense'; }

    function guessHeader(headers, kind){
      const synonyms={
        date:['date','fecha','transaction date','posted','day'],
        desc:['description','details','memo','note','concept','concepto'],
        cat:['category','categorÃ­a','categoria','group','type of expense'],
        type:['type','income/outcome','income/expense','flow','in/out','io','credit/debit','cr/dr'],
        amt:['amount','monto','importe','value','total','debit','credit','dr','cr']
      }[kind];
      const norm=headers.map(h=>normalizeHeader(h));
      for(const syn of synonyms){ const idx=norm.findIndex(h=>h===syn||h.includes(syn)); if(idx!==-1) return headers[idx]; }
      return headers[0];
    }

    // ===== URL & CSV helpers =====
    function normalizeGsUrl(u){
      try{
        const url=new URL(u);
        if(url.hostname.includes('docs.google.com') && url.pathname.includes('/spreadsheets/')){
          // /spreadsheets/d/{id}
          if(/\/spreadsheets\/d\//.test(url.pathname)){
            const m=url.pathname.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); const id=m?m[1]:null; if(id){ let gid=null; const hash=(url.hash||'').replace('#',''); const hashParams=new URLSearchParams(hash); if(hashParams.has('gid')) gid=hashParams.get('gid'); if(url.searchParams.has('gid')) gid=url.searchParams.get('gid'); const out=new URL(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv`); if(gid) out.searchParams.set('gid', gid); return out.toString(); }
          }
          // /spreadsheets/d/e/.../pubhtml
          if(/\/spreadsheets\/d\/e\//.test(url.pathname)){
            return url.toString().replace(/pubhtml.*/,'pub?output=csv');
          }
        }
        return u;
      }catch{ return u; }
    }

    function cacheGet(key){ try{ const all=JSON.parse(localStorage.getItem(LS_KEYS.cache)||'{}'); return all[key]; }catch{return undefined;} }
    function cacheSet(key,val){ const all=JSON.parse(localStorage.getItem(LS_KEYS.cache)||'{}'); all[key]=val; localStorage.setItem(LS_KEYS.cache, JSON.stringify(all)); }
    function cacheDeletePrefix(prefix){ try{ const all=JSON.parse(localStorage.getItem(LS_KEYS.cache)||'{}'); for(const k of Object.keys(all)){ if(k.startsWith(prefix)) delete all[k]; } localStorage.setItem(LS_KEYS.cache, JSON.stringify(all)); }catch{} }
    function isProbablyHtml(text,ct){ if(ct && /text\/html/i.test(ct)) return true; const h=text.slice(0,200).toLowerCase(); return h.includes('<!doctype html')||h.includes('<html'); }

    function buildCsvCandidates(u, {bypassCache=false}={}){
      const cb = bypassCache ? `cb=${Date.now()}` : null;
      try{
        const url=new URL(u);
        if(url.hostname.includes('docs.google.com') && url.pathname.includes('/spreadsheets/')){
          const c=[];
          // /spreadsheets/d/{id}
          if(/\/spreadsheets\/d\//.test(url.pathname)){
            const m=url.pathname.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/); const id=m?m[1]:null; let gid=null; const hash=(url.hash||'').replace('#',''); const hp=new URLSearchParams(hash); if(hp.has('gid')) gid=hp.get('gid'); if(url.searchParams.has('gid')) gid=url.searchParams.get('gid');
            const exp=new URL(`https://docs.google.com/spreadsheets/d/${id}/export?format=csv`); if(gid) exp.searchParams.set('gid', gid); if(cb) exp.searchParams.set('cb', cb); c.push(exp.toString());
            const pub=new URL(`https://docs.google.com/spreadsheets/d/${id}/pub?output=csv`); if(gid) pub.searchParams.set('gid', gid); if(cb) pub.searchParams.set('cb', cb); c.push(pub.toString());
            const gviz=new URL(`https://docs.google.com/spreadsheets/d/${id}/gviz/tq?tqx=out:csv`); if(gid) gviz.searchParams.set('gid', gid); if(cb) gviz.searchParams.set('cb', cb); c.push(gviz.toString());
            return c;
          }
          // /spreadsheets/d/e/.../pubhtml
          if(/\/spreadsheets\/d\/e\//.test(url.pathname)){
            const a=new URL(url.toString().replace(/pubhtml.*/,'pub?output=csv')); if(cb) a.searchParams.set('cb', cb); c.push(a.toString());
            const b=new URL(url.toString().replace(/pubhtml.*/,'gviz/tq?tqx=out:csv')); if(cb) b.searchParams.set('cb', cb); c.push(b.toString());
            return c;
          }
        }
      }catch{}
      return [cb? (u + (u.includes('?')?'&':'?') + 'cb='+cb) : u];
    }

    async function fetchCsvSmart(url, {bypassCache=false}={}){
      // If forcing fresh, wipe CSV cache to prevent stale hits
      if(bypassCache){ cacheDeletePrefix('csv:'); }
      const candidates=buildCsvCandidates(url, {bypassCache});
      let lastErr=null;
      for(const cand of candidates){
        try{
          const cacheKey='csv:'+cand;
          if(!bypassCache){ const cached=cacheGet(cacheKey); if(cached){ return Papa.parse(cached,{header:true,skipEmptyLines:true}).data; } }
          const res=await fetch(cand,{
            cache:'reload',
            headers:{'Cache-Control':'no-cache, no-store, must-revalidate','Pragma':'no-cache','Expires':'0'}
          });
          if(!res.ok) throw new Error('HTTP '+res.status);
          const text=await res.text();
          const ct=res.headers.get('content-type')||'';
          if(isProbablyHtml(text,ct)) throw new Error('HTML returned (sign-in/permissions)');
          if(!/[,\n]/.test(text)) throw new Error('No CSV structure');
          cacheSet(cacheKey,text);
          return Papa.parse(text,{header:true,skipEmptyLines:true}).data;
        }catch(e){ lastErr=e; console.warn('CSV candidate failed', cand, e.message); }
      }
      throw new Error('All CSV endpoints failed. Last error: '+(lastErr?lastErr.message:'unknown'));
    }

    // ===== Links =====
    function getLinks(){try{return JSON.parse(localStorage.getItem(LS_KEYS.links)||'[]')}catch{return[]}}
    function setLinks(list){ localStorage.setItem(LS_KEYS.links, JSON.stringify(Array.from(new Set(list)))); renderLinks(); }
    function addLink(input){ const raw=String(input||'').trim(); if(!raw){ toast('Paste a link first'); return; } const parts=raw.split(/[\n,]+/).map(s=>s.trim()).filter(Boolean); const list=getLinks(); for(const p of parts){ const n=normalizeGsUrl(p); if(!list.includes(n)) list.push(n); } setLinks(list); }
    function removeLink(u){ const list=getLinks().filter(x=>x!==u); setLinks(list); }

    function renderLinks(){ const list=getLinks(); linkList.classList.toggle('hidden', list.length===0); linksUl.innerHTML=list.map(u=>{ const norm=normalizeGsUrl(u); return `<li class="p-2 border border-slate-200 rounded bg-white flex items-center justify-between gap-2"><div class="min-w-0"><div class="truncate text-slate-700">${u}</div><div class="truncate text-xs text-slate-500">Fetch: <code>${norm}</code></div></div><div class="flex gap-2"><a class="btn text-xs" target="_blank" href="${norm}">Test</a><button class="btn text-xs" data-remove="${u}">Remove</button></div></li>`; }).join(''); linksUl.querySelectorAll('button[data-remove]').forEach(b=> b.addEventListener('click', e=> removeLink(e.currentTarget.dataset.remove))); }

    // ===== Transform =====
    let ROW_ID=0;
    function transformRows(raw){ if(!raw||!raw.length) return []; const headers=Object.keys(raw[0]||{}); const kDate=guessHeader(headers,'date'); const kDesc=guessHeader(headers,'desc'); const kCat=guessHeader(headers,'cat'); const kType=guessHeader(headers,'type'); const kAmt=guessHeader(headers,'amt'); const rows=[]; for(const r of raw){ const d=parseDate(r[kDate]); const a=parseAmount(r[kAmt]); if(isNaN(a)) continue; const t=inferType(r[kType], a); rows.push({ id:ROW_ID++, date:d||null, desc:String(r[kDesc]||''), category:String(r[kCat]||'(Uncategorized)'), type:t, amount:Math.abs(a) }); } return rows; }

    function computeKPIs(rows){ const inc=rows.filter(x=>x.type==='income').reduce((s,x)=>s+x.amount,0); const exp=rows.filter(x=>x.type==='expense').reduce((s,x)=>s+x.amount,0); const bal=SETTINGS.starting + inc - exp; kpiIncome.textContent=fmtCurrency(inc); kpiExpense.textContent=fmtCurrency(exp); kpiNet.textContent=fmtCurrency(inc-exp); kpiBalance.textContent=fmtCurrency(bal); balanceBadge.textContent = bal < SETTINGS.low ? 'LOW' : 'OK'; balanceBadge.style.borderColor = bal < SETTINGS.low ? '#f87171' : '#34d399'; balanceBadge.style.color = bal < SETTINGS.low ? '#b91c1c' : '#065f46'; return {inc,exp,bal}; }

    function computeRunningBalance(rows){
      RB.clear();
      let bal=parseFloat(SETTINGS.starting||0);
      const chrono = rows.slice().sort((a,b)=> (a.date? a.date.getTime():0) - (b.date? b.date.getTime():0));
      for(const r of chrono){ bal += (r.type==='income'? r.amount : -r.amount); RB.set(r.id, bal); }
    }

    function renderAlerts(rows, kpis){
      const low=parseFloat(SETTINGS.low||0);
      const sorted=rows.slice().sort((a,b)=> (a.date? a.date.getTime():0) - (b.date? b.date.getTime():0));
      let bal=parseFloat(SETTINGS.starting||0);
      const events=[];
      for(const r of sorted){ bal += (r.type==='income'? r.amount : -r.amount); if(r.date && bal<low){ events.push({date:r.date, balance:bal, note:`${r.type==='expense'?'Expense':'Income'}: ${r.desc||'(no description)'}`}); } }
      alertsBody.innerHTML = events.length ? events.map(e=>`<tr><td class="px-2 py-1">${e.date.toISOString().slice(0,10)}</td><td class="px-2 py-1 text-right">${fmtCurrency(e.balance)}</td><td class="px-2 py-1">${e.note}</td></tr>`).join('') : `<tr><td colspan="3" class="px-2 py-2 text-slate-600">No low-balance events.</td></tr>`;

      // 30â€‘day coverage check
      const today=new Date(); today.setHours(0,0,0,0);
      const in30=new Date(today); in30.setDate(in30.getDate()+30);
      const upcomingExp = rows.filter(r=> r.type==='expense' && r.date && r.date>today && r.date<=in30).reduce((s,x)=>s+x.amount,0);
      const upcomingInc = rows.filter(r=> r.type==='income' && r.date && r.date>today && r.date<=in30).reduce((s,x)=>s+x.amount,0);

      // If there are no future-dated rows, fallback to simple projection: average daily net from last 60 days
      let projected = kpis.bal + upcomingInc - upcomingExp;
      if(upcomingExp===0 && upcomingInc===0){
        const past60=new Date(today); past60.setDate(past60.getDate()-60);
        const pastRows=rows.filter(r=> r.date && r.date>past60 && r.date<=today);
        const netPast=pastRows.reduce((s,x)=> s + (x.type==='income'? x.amount : -x.amount), 0);
        const days=Math.max(1, (today - past60)/(1000*60*60*24));
        const avgDaily=netPast/days; // could be negative
        projected = kpis.bal + avgDaily*30;
      }

      const recs=[];
      if(projected < 0 || projected < low){
        const gap = Math.abs(Math.min(projected, projected-low));
        recs.push(`âš ï¸ In 30 days you ${projected<0? 'will be negative' : 'may be below your threshold'}: ${fmtCurrency(projected)}.`);
        recs.push(`You need ~${fmtCurrency(gap)} more income or cuts within 30 days to stay above ${fmtCurrency(low)}.`);
        // Target high-impact categories (next 30d if available, else last 30d)
        const baseRows=(upcomingExp>0? rows.filter(r=> r.type==='expense' && r.date && r.date>today && r.date<=in30)
                                     : rows.filter(r=> r.type==='expense' && r.date && r.date>new Date(today-1000*60*60*24*30) && r.date<=today));
        const byCat={}; baseRows.forEach(r=> byCat[r.category]=(byCat[r.category]||0)+r.amount );
        const topCats=Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0,3);
        if(topCats.length) recs.push(`Trim these categories: ${topCats.map(([c,v])=>`${c} (${fmtCurrency(v)})`).join(', ')}.`);
      } else {
        recs.push(`âœ… Based on current data, you can cover the next 30 days. Projected balance: ${fmtCurrency(projected)}.`);
      }

      // Recurring expense detection (helpful optimization targets)
      const byDesc={}; rows.filter(r=>r.type==='expense').forEach(r=>{ const k=(r.desc||'').toLowerCase(); byDesc[k]=(byDesc[k]||{count:0,total:0,pretty:r.desc}); byDesc[k].count++; byDesc[k].total+=r.amount; });
      const recurring = Object.values(byDesc).filter(x=>x.count>=3).sort((a,b)=>b.total-a.total).slice(0,3);
      if(recurring.length){ recs.push(`Recurring spend to renegotiate: ${recurring.map(x=>`${x.pretty} Ã—${x.count} (${fmtCurrency(x.total)})`).join(', ')}.`); }

      recsList.innerHTML = recs.map(r=>`<li>${r}</li>`).join('');
    }

    // ===== Charts =====
    let barChart, pieChart;
    function renderCharts(rows){
      Chart.defaults.color='#0f172a'; Chart.defaults.font.size=13;
      const buckets={}; for(const r of rows){ if(!r.date) continue; const k=monthKey(r.date); if(!buckets[k]) buckets[k]={income:0,expense:0}; buckets[k][r.type]+=r.amount; }
      const labels=Object.keys(buckets).sort(); const income=labels.map(k=>buckets[k].income); const expense=labels.map(k=>buckets[k].expense);
      const ctxB=document.getElementById('barChart'); if(barChart) barChart.destroy(); barChart=new Chart(ctxB,{type:'bar',data:{labels,datasets:[{label:'Income',data:income},{label:'Expense',data:expense}]},options:{responsive:true,scales:{x:{ticks:{color:'#0f172a'},grid:{color:'#e2e8f0'}},y:{beginAtZero:true,ticks:{color:'#0f172a'},grid:{color:'#e2e8f0'}}},plugins:{legend:{labels:{color:'#0f172a'}},tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${fmtCurrency(c.parsed.y)}`}}}}});
      const byCat={}; rows.filter(r=>r.type==='expense').forEach(r=> byCat[r.category]=(byCat[r.category]||0)+r.amount );
      const pLabels=Object.keys(byCat).sort((a,b)=>byCat[b]-byCat[a]); const pData=pLabels.map(l=>byCat[l]);
      const ctxP=document.getElementById('pieChart'); if(pieChart) pieChart.destroy(); pieChart=new Chart(ctxP,{type:'doughnut',data:{labels:pLabels,datasets:[{data:pData}]} , options:{plugins:{legend:{labels:{color:'#0f172a'}},tooltip:{callbacks:{label:c=>`${c.label}: ${fmtCurrency(c.parsed)}`}}}}});
    }

    // ===== Table =====
    function applySort(rows){ const dir=SORT.dir==='asc'?1:-1; return rows.sort((a,b)=>{ const k=SORT.key; if(k==='amount') return (a.amount-b.amount)*dir; if(k==='date') return ((a.date? a.date.getTime():0) - (b.date? b.date.getTime():0))*dir; const av=(a[k]||'').toString().toLowerCase(); const bv=(b[k]||'').toString().toLowerCase(); return av<bv? -1*dir : av>bv? 1*dir : 0; }); }
    function paginate(rows){ const total=Math.max(1, Math.ceil(rows.length/PAGE.size)); if(PAGE.index>total) PAGE.index=total; const start=(PAGE.index-1)*PAGE.size; return { slice: rows.slice(start, start+PAGE.size), totalPages: total, totalRows: rows.length }; }
    function escapeHtml(str){ return String(str).replace(/[&<>\"]/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s])); }
    function renderTable(rows){ const fmt=d=> d? d.toISOString().slice(0,10) : 'â€”'; const fmtAmt=(n,t)=>`${t==='expense'?'-':''}${fmtCurrency(n)}`; const sorted=applySort(rows.slice()); const {slice,totalPages,totalRows}=paginate(sorted); tbody.innerHTML=slice.map(r=>`<tr class="border-t border-slate-200"><td class="px-3 py-2 whitespace-nowrap">${fmt(r.date)}</td><td class="px-3 py-2">${escapeHtml(r.desc)||'<span class=\'text-slate-400\'>(No description)</span>'}</td><td class="px-3 py-2">${escapeHtml(r.category)}</td><td class="px-3 py-2">${r.type==='income'?'Income':'Expense'}</td><td class="px-3 py-2 text-right">${fmtAmt(r.amount,r.type)}</td><td class="px-3 py-2 text-right">${fmtCurrency(RB.get(r.id) ?? SETTINGS.starting)}</td></tr>`).join(''); rowCount.textContent=totalRows; pageInfo.textContent=`Page ${PAGE.index} / ${totalPages}`; prevPage.disabled=PAGE.index<=1; nextPage.disabled=PAGE.index>=totalPages; }

    // ===== Render All =====
    function renderAll(){ const rows=transformRows(RAW_ROWS); if(!rows.length){ tbody.innerHTML='<tr><td colspan="6" class="px-3 py-3 text-slate-600">No valid rows parsed. Check your headers and that the tab has data.</td></tr>'; kpiIncome.textContent='â€”'; kpiExpense.textContent='â€”'; kpiNet.textContent='â€”'; kpiBalance.textContent='â€”'; balanceBadge.textContent='â€”'; alertsBody.innerHTML=''; recsList.innerHTML=''; if(statusBar){ statusBar.textContent = `Last updated ${new Date().toLocaleString()} â€¢ rows: 0`; } return; } const kpis=computeKPIs(rows); computeRunningBalance(rows); renderAlerts(rows, kpis); renderCharts(rows); renderTable(rows); if(statusBar){ const sources=(getLinks()||[]).length; statusBar.textContent = `Last updated ${new Date().toLocaleString()} â€¢ sources: ${sources} â€¢ rows: ${rows.length}`; } }

    // ===== Loaders =====
    async function loadData({bypassCache=false}={}){
      const list=getLinks(); if(list.length===0){ toast('Add at least one CSV link.'); return; }
      RAW_HEADERS=new Set(); RAW_ROWS=[]; // reset rows for a real refresh
      if(bypassCache || alwaysFresh.checked){ cacheDeletePrefix('csv:'); }
      loadBtn.disabled=true; loadBtn.textContent='Loadingâ€¦';
      try{
        for(const url of list){ const rows=await fetchCsvSmart(url,{bypassCache: bypassCache || alwaysFresh.checked}); if(rows&&rows.length){ RAW_ROWS.push(...rows); Object.keys(rows[0]).forEach(h=>RAW_HEADERS.add(h)); } }
        if(RAW_ROWS.length===0){ toast('Loaded 0 rows. Check link permissions/tab.'); }
        renderAll(); toast('Data loaded');
      }catch(e){ console.error(e); alert('Error: '+e.message); }
      finally{ loadBtn.disabled=false; loadBtn.textContent='Load'; }
    }

    // ===== Events =====
    addLinkBtn.addEventListener('click',()=>{ addLink(csvUrl.value); csvUrl.value=''; });
    loadBtn.addEventListener('click',()=>loadData({bypassCache:false}));
    refreshBtn.addEventListener('click',()=>loadData({bypassCache:true}));
    document.getElementById('clearCsvCacheBtn').addEventListener('click',()=>{ cacheDeletePrefix('csv:'); toast('CSV cache purged'); });
    loadSampleBtn.addEventListener('click',()=>{ const sample=`Date,Description,Category,Type,Amount\n2025-01-01,Salary,Job,Income,2500\n2025-01-03,Groceries,Food,Expense,-120.75\n2025-01-05,Freelance,Side,Income,600\n2025-01-07,Electricity,Utilities,Expense,-80.5`; RAW_ROWS=Papa.parse(sample,{header:true}).data; renderAll(); toast('Sample loaded'); });
    resetBtn.addEventListener('click',()=>{ if(confirm('Clear links, settings, and cache?')){ localStorage.removeItem(LS_KEYS.links); localStorage.removeItem(LS_KEYS.settings); localStorage.removeItem(LS_KEYS.cache); location.reload(); } });

    document.querySelectorAll('th[data-sort]').forEach(th=> th.addEventListener('click', ()=>{ const key=th.getAttribute('data-sort'); if(SORT.key===key) SORT.dir= (SORT.dir==='asc')?'desc':'asc'; else { SORT.key=key; SORT.dir='asc'; } renderAll(); }));
    prevPage.addEventListener('click', ()=>{ PAGE.index=Math.max(1, PAGE.index-1); renderAll(); });
    nextPage.addEventListener('click', ()=>{ PAGE.index=PAGE.index+1; renderAll(); });

    saveSettingsBtn.addEventListener('click', ()=>{ SETTINGS.currency=currencySel.value; SETTINGS.locale=localeSel.value; SETTINGS.starting=parseFloat(startingBalanceEl.value||0); SETTINGS.low=parseFloat(lowThresholdEl.value||0); localStorage.setItem(LS_KEYS.settings, JSON.stringify(SETTINGS)); toast('Settings saved'); renderAll(); });

    // ===== Init =====
    function loadSettings(){ const s=JSON.parse(localStorage.getItem(LS_KEYS.settings)||'null'); if(s) SETTINGS={...SETTINGS,...s}; currencySel.value=SETTINGS.currency; localeSel.value=SETTINGS.locale; startingBalanceEl.value=SETTINGS.starting; lowThresholdEl.value=SETTINGS.low; if(s && 'alwaysFresh' in s){ alwaysFresh.checked = !!s.alwaysFresh; } }
    function initParams(){ const csv= new URLSearchParams(location.search).get('csv'); if(csv){ csv.split(',').forEach(u=> addLink(decodeURIComponent(u))); } }
    alwaysFresh.addEventListener('change', ()=>{ const s=JSON.parse(localStorage.getItem(LS_KEYS.settings)||'{}'); s.alwaysFresh = alwaysFresh.checked; localStorage.setItem(LS_KEYS.settings, JSON.stringify(s)); });

    (function init(){ loadSettings(); renderLinks(); initParams(); })();
  </script>

  <!-- Helper: quick instructions for Google Sheets publishing
  1) File â†’ Publish to the web â†’ Select the specific tab â†’ CSV â†’ Publish.
  2) Copy the /pub?output=csv link and paste it into the Add link box.
  3) Or use /export?format=csv&gid=... with Link sharing = Anyone with the link (Viewer).
  -->
</body>
</html>
