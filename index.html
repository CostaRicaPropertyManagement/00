<script>
// --- Auto-fill Remaining Capacity ---
async function autoFillRemaining(){
  try{
    setStatus('Auto-filling…'); setProgress(0);
    const un = state.assignments.get('Unassigned') || new Set();
    if (un.size === 0) { setStatus('Nothing to auto-fill.'); return; }

    // Build a list of contractors with remaining capacity
    const roster = [];
    for (const [name, cap] of state.capacities.entries()){
      const used = (state.assignments.get(name)?.size) || 0;
      const remaining = Math.max(0, cap - used);
      if (remaining > 0){
        roster.push({
          name,
          remaining,
          homeAddress: (state.contractorMeta.get(name)||{}).homeAddress || ''
        });
      }
    }
    if (roster.length === 0){ setStatus('All contractors at capacity.'); return; }

    // We’ll iterate unassigned tasks (stable order) and place each with the best contractor
    const toPlace = [...un];
    const total = toPlace.length;
    let placed = 0;

    for (let i=0; i<toPlace.length; i++){
      const id = toPlace[i];
      // If everyone is full, stop early
      if (roster.every(r => r.remaining === 0)) break;

      const t = state.tasks.find(x => x.id === id);
      if (!t) continue;

      // Find best contractor (with remaining) by actual driving distance
      let best = null, bestDist = Number.POSITIVE_INFINITY, bestDur = 0;
      for (const r of roster){
        if (r.remaining <= 0) continue;
        const dm = await getDistanceAndDuration(r.homeAddress, t.lat, t.lng);
        const d  = dm?.distanceMeters ?? Number.POSITIVE_INFINITY;
        if (d < bestDist){
          best = r; bestDist = d; bestDur = dm?.durationSeconds || 0;
        }
      }

      if (best && isFinite(bestDist)){
        // Assign
        un.delete(id);
        const set = state.assignments.get(best.name) || new Set();
        set.add(id); state.assignments.set(best.name, set);
        t.assignedTo = best.name; t.distanceMeters = bestDist; t.durationSeconds = bestDur;
        best.remaining--;
        placed++;
      }

      setProgress(((i+1)/total)*100);
    }

    // Refresh UI
    renderBoard(); renderTables(); renderChart();
    document.getElementById('kpiAssigned').textContent = String(state.tasks.filter(x=>x.assignedTo).length);
    document.getElementById('pillCalls').textContent = String(state.dmCalls);
    setStatus(placed ? `Auto-filled ${placed} task${placed===1?'':'s'}.` : 'No tasks were auto-filled.');
  } catch (e){
    console.error(e);
    setStatus('Error: '+e.message);
  }
}

// Wire the button
document.getElementById('autofillBtn')?.addEventListener('click', autoFillRemaining);
</script>
